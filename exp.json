AWSTemplateFormatVersion: '2010-09-09'
Description: IAM Role with permissions to view and describe resources in AWS Organizations, IAM, and root account-related information, with External ID for cross-account trust.

Parameters:
  ExternalId:
    Description: The External ID used for cross-account role assumption
    Type: String
    NoEcho: true # Optional: This hides the ExternalId from being displayed in the CloudFormation console

  MasterAccountId:
    Description: The AWS account ID of the master account that needs to assume this role
    Type: String
    AllowedPattern: "^[0-9]{12}$"
    ConstraintDescription: "The Account ID must be a 12-digit number."

  TrustedAccountId:
    Description: The AWS account ID that needs to be trusted
    Type: String
    AllowedPattern: "^[0-9]{12}$"
    ConstraintDescription: "The Account ID must be a 12-digit number."

Resources:
  IAMRole:
    Type: 'AWS::IAM::Role'
    Properties: 
      RoleName: 'DiscoveryIAMRole'
      AssumeRolePolicyDocument: 
        Version: '2012-10-17'
        Statement: 
          - Effect: Allow
            Principal:
              AWS: 
                - !Sub arn:aws:iam::${MasterAccountId}:root
                - !Sub arn:aws:iam::${TrustedAccountId}:root
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                sts:ExternalId: !Ref ExternalId
      Policies:
        - PolicyName: 'DiscoveryPolicy'
          PolicyDocument: 
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  # EC2 Permissions
                  - ec2:DescribeRegions
                  - ec2:DescribeInstances
                  - ec2:DescribeVolumes
                  
                  # S3 Permissions
                  - s3:ListBuckets
                  - s3:GetBucketLocation
                  
                  # KMS Permissions
                  - kms:ListKeys
                  - kms:DescribeKey
                  
                  # AWS Organizations Permissions
                  - organizations:DescribeOrganization
                  - organizations:DescribeAccount
                  - organizations:DescribeOrganizationalUnit
                  - organizations:DescribePolicy
                  - organizations:DescribeEffectivePolicy
                  - organizations:ListAccounts
                  - organizations:ListOrganizationalUnitsForParent
                  - organizations:ListPolicies
                  - organizations:ListPoliciesForTarget
                  - organizations:ListRoots
                  - organizations:ListTagsForResource
                  - organizations:ListChildren

                  # IAM Permissions
                  - iam:GetUser
                  - iam:GetUserPolicy
                  - iam:ListUsers
                  - iam:ListGroups
                  - iam:ListRoles
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:ListPolicies
                  - iam:GetPolicy
                  - iam:GetPolicyVersion
                  - iam:ListAttachedUserPolicies
                  - iam:ListAttachedRolePolicies
                  - iam:ListAttachedGroupPolicies
                  - iam:GetGroup
                  - iam:GetGroupPolicy
                  - iam:GetInstanceProfile
                  - iam:ListInstanceProfiles
                  - iam:GetLoginProfile
                  - iam:GetCredentialReport
                  - iam:GetAccessKeyLastUsed
                  
                  # Root Account Related (IAM) Permissions
                  - iam:GetAccountSummary
                  - iam:ListAccountAliases
                  - iam:GetAccountAuthorizationDetails
                Resource: '*'
                Condition:
                  StringNotEqualsIfExists:
                    aws:RequestedRegion:
                      - ap-south-2
                      - af-south-1
                      - eu-south-1
                      - eu-south-2
                      - me-south-1
                      - me-central-1
                      - il-central-1
                      - ap-east-1
                      - ca-west-1
                      - ap-southeast-3
                      - eu-central-2
                      - ap-southeast-4
                      - ap-southeast-5

Outputs:
  IAMRoleArn:
    Description: 'The ARN of the created IAM role'
    Value: !GetAtt IAMRole.Arn
